#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
JAR_FILE="$REPO_DIR/build/libs/Commit-Duck.jar"

build() {
  echo "Building with Gradle..."
  cd "$REPO_DIR"
  if [ ! -f "$JAR_FILE" ]; then
    ./gradlew jar -q
  fi
}

run_java() {
  java -jar "$JAR_FILE" "$@"
}

install_hooks() {
  build
  HOOK_DIR="$REPO_DIR/.git/hooks"
  mkdir -p "$HOOK_DIR"
  cat > "$HOOK_DIR/post-commit" <<'EOS'
#!/usr/bin/env bash
set -e
REPO_DIR="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
# 同リポジトリの duck があれば refresh 実行（静かに失敗許容）
if [ -x "$REPO_DIR/duck" ]; then
  "$REPO_DIR/duck" refresh >/dev/null 2>&1 || true
fi
EOS
  chmod +x "$HOOK_DIR/post-commit"
  echo "Installed .git/hooks/post-commit"
  echo "Done."
}

case "${1-}" in
  install)
    install_hooks
    ;;
  refresh)
    build
    run_java refresh
    ;;
  status)
    build
    run_java status
    ;;
  help|"")
    echo "duck install | status | refresh | help"
    ;;
  *)
    echo "unknown subcommand: $1"
    echo "try: duck help"
    exit 1
    ;;
esac
